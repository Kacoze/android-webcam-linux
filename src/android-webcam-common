#!/bin/bash
# android-webcam-common - shared functions for android-webcam-ctl

validate_ip() {
    local ip="$1"
    if [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
        IFS='.' read -ra ADDR <<< "$ip"
        for i in "${ADDR[@]}"; do
            if (( 10#$i < 0 || 10#$i > 255 )); then
                return 1
            fi
        done
        return 0
    fi
    return 1
}

check_scrcpy_version() {
    local scrcpy_bin="$1"
    if [ -z "$scrcpy_bin" ] || [ ! -x "$scrcpy_bin" ]; then
        echo "0.0"
        return
    fi
    local version_output
    version_output=$("$scrcpy_bin" --version 2>/dev/null || echo "")
    if [ -z "$version_output" ]; then
        echo "0.0"
        return
    fi
    # Extract version using sed (portable)
    if command -v head >/dev/null 2>&1; then
        echo "$version_output" | sed -n 's/.*scrcpy[[:space:]]*\([0-9]\+\.[0-9]\+\(.[0-9]\+\)\?\).*/\1/p' | head -n 1 || echo "0.0"
    else
        echo "$version_output" | sed -n 's/.*scrcpy[[:space:]]*\([0-9]\+\.[0-9]\+\(.[0-9]\+\)\?\).*/\1/p' | sed -n '1p' || echo "0.0"
    fi
}

version_compare() {
    # Compare versions using sort -V: check if current >= required
    local required="$1"
    local current="$2"
    if [ "$current" = "0.0" ]; then
        return 1
    fi
    if ! command -v sort >/dev/null 2>&1; then
        # Without sort -V we cannot reliably compare; accept current.
        return 0
    fi
    local smallest
    if command -v head >/dev/null 2>&1; then
        smallest=$(printf '%s\n' "$required" "$current" | sort -V | head -n 1)
    else
        smallest=$(printf '%s\n' "$required" "$current" | sort -V | sed -n '1p')
    fi
    [ "$smallest" = "$required" ]
}

scrcpy_is_compatible() {
    local bin="$1"
    local required="2.0"
    local current
    current=$(check_scrcpy_version "$bin")
    version_compare "$required" "$current"
}

find_scrcpy() {
    # Prefer the self-installed GitHub fallback (and generally newer builds),
    # then Snap, then system PATH, then Flatpak.
    if [ -x "$HOME/.local/bin/scrcpy" ] && scrcpy_is_compatible "$HOME/.local/bin/scrcpy"; then
        echo "$HOME/.local/bin/scrcpy"
        return 0
    fi
    if [ -x /snap/bin/scrcpy ] && scrcpy_is_compatible "/snap/bin/scrcpy"; then
        echo "/snap/bin/scrcpy"
        return 0
    fi
    if command -v scrcpy >/dev/null 2>&1; then
        local path_bin
        path_bin="$(command -v scrcpy)"
        if [ -x "$path_bin" ] && scrcpy_is_compatible "$path_bin"; then
            echo "$path_bin"
            return 0
        fi
    fi
    if command -v flatpak >/dev/null 2>&1 && flatpak list --app 2>/dev/null | grep -q org.scrcpy.ScrCpy; then
        # Flatpak version check (best-effort)
        local v="0.0"
        if command -v head >/dev/null 2>&1; then
            v=$(flatpak run org.scrcpy.ScrCpy --version 2>/dev/null | sed -n 's/.*scrcpy[[:space:]]*\([0-9]\+\.[0-9]\+\(.[0-9]\+\)\?\).*/\1/p' | head -n 1 || echo "0.0")
        else
            v=$(flatpak run org.scrcpy.ScrCpy --version 2>/dev/null | sed -n 's/.*scrcpy[[:space:]]*\([0-9]\+\.[0-9]\+\(.[0-9]\+\)\?\).*/\1/p' | sed -n '1p' || echo "0.0")
        fi
        if version_compare "2.0" "$v"; then
            echo "flatpak run org.scrcpy.ScrCpy"
            return 0
        fi
    fi
    return 1
}
