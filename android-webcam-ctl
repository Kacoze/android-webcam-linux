#!/bin/bash
# android-webcam-ctl
# Central control script for Android Webcam on Linux

CONFIG_DIR="$HOME/.config/android-webcam"
CONFIG_FILE="$CONFIG_DIR/settings.conf"
LOG_FILE="/tmp/android-cam.log"

# Default configuration values
DEFAULT_CAMERA_FACING="back" # front, back, external
DEFAULT_VIDEO_SIZE=""        # e.g. 1920x1080 (empty = max supported)
DEFAULT_BIT_RATE="8M"
DEFAULT_ARGS="--no-audio --buffer=400"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# --- Config Management ---

load_config() {
    # Ensure config dir exists
    mkdir -p "$CONFIG_DIR"
    
    # Migration from v2.0 (config.env) if settings.conf missing
    if [ ! -f "$CONFIG_FILE" ] && [ -f "$CONFIG_DIR/config.env" ]; then
        source "$CONFIG_DIR/config.env"
        # Extract IP from OLD format (IP:PORT)
        CLEAN_IP=$(echo "$PHONE_IP" | cut -d: -f1)
        
        # Write new config
        cat << EOF > "$CONFIG_FILE"
# Android Webcam Configuration
PHONE_IP="$CLEAN_IP"
CAMERA_FACING="$DEFAULT_CAMERA_FACING"
VIDEO_SIZE="$DEFAULT_VIDEO_SIZE"
BIT_RATE="$DEFAULT_BIT_RATE"
EXTRA_ARGS="$DEFAULT_ARGS"
EOF
    fi
    
    # Create default if nothing exists
    if [ ! -f "$CONFIG_FILE" ]; then
        cat << EOF > "$CONFIG_FILE"
# Android Webcam Configuration
PHONE_IP=""
CAMERA_FACING="$DEFAULT_CAMERA_FACING"
VIDEO_SIZE="$DEFAULT_VIDEO_SIZE"
BIT_RATE="$DEFAULT_BIT_RATE"
EXTRA_ARGS="$DEFAULT_ARGS"
EOF
    fi

    source "$CONFIG_FILE"
}

# --- Helpers ---

notify() {
    local level="$1"
    local title="$2"
    local msg="$3"
    local icon="$4"
    if [ -z "$icon" ]; then icon="camera-web"; fi
    notify-send -u "$level" -i "$icon" "$title" "$msg"
}

is_running() {
    pgrep -f "scrcpy.*video-source=camera" > /dev/null
}

find_scrcpy() {
    if command -v scrcpy >/dev/null; then
        echo "$(command -v scrcpy)"
    elif [ -f /snap/bin/scrcpy ]; then
        echo "/snap/bin/scrcpy"
    else
        return 1
    fi
}

# --- Commands ---

cmd_start() {
    load_config
    
    if is_running; then
        echo "Camera is already active."
        notify "low" "Android Camera" "Already active"
        return 0
    fi
    
    if [ -z "$PHONE_IP" ]; then
        echo -e "${RED}Error:${NC} PHONE_IP not set. Run '$0 config' to edit settings."
        notify "critical" "Android Camera" "Config Error: No IP set" "error"
        return 1
    fi

    echo -e "${BLUE}Connecting to $PHONE_IP...${NC}"
    notify "normal" "Android Camera" "‚åõ Connecting..."

    # Connection attempt
    adb connect "$PHONE_IP:5555" > /dev/null
    
    SCRCPY_BIN=$(find_scrcpy)
    if [ -z "$SCRCPY_BIN" ]; then
        echo -e "${RED}Error:${NC} scrcpy not found!"
        notify "critical" "Android Camera" "Error: scrcpy not found" "error"
        return 1
    fi

    # Construct the command
    # Using arrays for arguments to handle spacing correctly
    CMD=("$SCRCPY_BIN")
    CMD+=("-s" "$PHONE_IP:5555")
    CMD+=("--video-source=camera")
    CMD+=("--camera-facing=$CAMERA_FACING")
    
    if [ ! -z "$VIDEO_SIZE" ]; then
        CMD+=("--max-size=$VIDEO_SIZE")
    fi
    
    if [ ! -z "$BIT_RATE" ]; then
        CMD+=("--video-bit-rate=$BIT_RATE")
    fi
    
    CMD+=("--v4l2-sink=/dev/video0")
    
    # Split EXTRA_ARGS string into array
    IFS=' ' read -r -a EXTRA_ARGS_ARRAY <<< "$EXTRA_ARGS"
    CMD+=("${EXTRA_ARGS_ARRAY[@]}")

    echo "Executing: ${CMD[*]}"
    
    # Run in background
    nohup "${CMD[@]}" > "$LOG_FILE" 2>&1 &
    PID=$!
    
    sleep 3
    if ps -p $PID > /dev/null; then
        echo -e "${GREEN}Started successfully (PID: $PID)${NC}"
        notify "normal" "Android Camera" "‚úÖ Active (PID: $PID)"
    else
        echo -e "${RED}Failed to start.${NC} Check $LOG_FILE"
        head -n 5 "$LOG_FILE"
        notify "critical" "Camera Error" "Failed to start. Check logs." "error"
    fi
}

cmd_stop() {
    if is_running; then
        pkill -f "scrcpy.*video-source=camera"
        echo -e "${YELLOW}Stopped.${NC}"
        notify "low" "Android Camera" "‚èπ Stopped"
    else
        echo "Not running."
    fi
}

cmd_toggle() {
    if is_running; then
        cmd_stop
    else
        cmd_start
    fi
}

cmd_fix() {
    notify-send -i smartphone "Camera Setup" "üîå Connect USB Cable..."
    echo -e "${BLUE}Waiting for USB device...${NC}"
    adb wait-for-usb-device
    echo "Device connected. Enabling TCP/IP mode..."
    adb tcpip 5555
    echo -e "${GREEN}Done! You can disconnect USB now.${NC}"
    notify-send -i smartphone "Camera Setup" "‚úÖ Fixed! Unplug USB."
}

cmd_status() {
    load_config
    echo -e "--- ${BLUE}Android Camera Status${NC} ---"
    
    if is_running; then
        PID=$(pgrep -f "scrcpy.*video-source=camera")
        echo -e "Status: ${GREEN}Active${NC} (PID: $PID)"
    else
        echo -e "Status: ${RED}Inactive${NC}"
    fi
    
    echo ""
    echo -e "--- ${BLUE}Configuration${NC} ---"
    echo "File: $CONFIG_FILE"
    echo "Phone IP:       ${PHONE_IP:-[Not Set]}"
    echo "Camera Facing:  $CAMERA_FACING"
    echo "Video Size:     ${VIDEO_SIZE:-Max}"
    echo "Bitrate:        $BIT_RATE"
}

cmd_config() {
    load_config
    EDITOR=${EDITOR:-nano}
    $EDITOR "$CONFIG_FILE"
}

# --- Main ---

case "$1" in
    start)  cmd_start ;;
    stop)   cmd_stop ;;
    toggle) cmd_toggle ;;
    fix)    cmd_fix ;;
    status) cmd_status ;;
    config) cmd_config ;;
    *)
        echo "Usage: $0 {start|stop|toggle|fix|status|config}"
        exit 1
        ;;
esac
