name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build installer from src
        run: ./scripts/build-installer.sh

      - name: Update installer checksum
        run: ./scripts/update-install-checksum.sh

      - name: Bash syntax check
        run: bash -n install.sh bootstrap.sh scripts/*.sh

      - name: Verify installer checksum
        run: ./scripts/verify-install-checksum.sh

      - name: One-liner preflight smoke test
        run: ANDROID_WEBCAM_LOCAL=1 bash bootstrap.sh --yes --check-only

      - name: Build Debian package (Ubuntu/Debian)
        run: ./scripts/build-deb.sh "${GITHUB_REF_NAME}"

      - name: Prepare minisign public key asset
        run: cp -f keys/minisign.pub minisign.pub

      - name: Install minisign
        run: sudo apt-get update && sudo apt-get install -y minisign

      - name: Sign release assets (optional)
        env:
          MINISIGN_SECRET_KEY: ${{ secrets.MINISIGN_SECRET_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${MINISIGN_SECRET_KEY:-}" ]; then
            echo "MINISIGN_SECRET_KEY not configured; skipping signing."
            exit 0
          fi
          echo "$MINISIGN_SECRET_KEY" > minisign.key
          minisign -Sm install.sh -s minisign.key -x install.sh.minisig
          minisign -Sm install.sh.sha256 -s minisign.key -x install.sh.sha256.minisig

      - name: Generate release notes
        run: ./scripts/generate-release-notes.sh "${GITHUB_REF_NAME}" > RELEASE_NOTES.md

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body_path: RELEASE_NOTES.md
          fail_on_unmatched_files: false
          files: |
            install.sh
            install.sh.sha256
            install.sh.minisig
            install.sh.sha256.minisig
            minisign.pub
            dist/*.deb
            dist/*.deb.sha256
