name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build installer from src
        run: ./scripts/build-installer.sh

      - name: Update installer checksum
        run: ./scripts/update-install-checksum.sh

      - name: Bash syntax check
        run: bash -n install.sh bootstrap.sh scripts/*.sh

      - name: Verify installer checksum
        run: ./scripts/verify-install-checksum.sh

      - name: One-liner preflight smoke test
        run: ANDROID_WEBCAM_LOCAL=1 bash bootstrap.sh --yes --check-only

      - name: Build Debian package (Ubuntu/Debian)
        run: ./scripts/build-deb.sh "${GITHUB_REF_NAME}"

      - name: Generate release notes
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '')
            const body = [
              '## Highlights',
              '- Automated release published from tag workflow.',
              '- Installer checksum and one-liner preflight validated in CI.',
              '',
              '## Installation (one-liner)',
              '```bash',
              'curl -fsSL https://raw.githubusercontent.com/Kacoze/android-webcam-linux/main/bootstrap.sh | bash',
              '```',
              '',
              `Tag: ${tag}`
            ].join('\n')
            core.setOutput('body', body)

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: ${{ steps.notes.outputs.body }}
          files: |
            install.sh
            install.sh.sha256
            dist/*.deb
